---
title: "Stability concerns in random matrices"
author: "Brad Duthie"
bibliography: references.bib
output:
  html_document: default
  pdf_document:
    fig_caption: yes
  word_document:
    fig_caption: yes
    pandoc_args:
    - --csl
    - evolution.csl
    reference_docx: docx_template.docx
header-includes:
- \usepackage{amsmath}
- \usepackage{natbib}
- \usepackage{lineno}
- \usepackage[utf8]{inputenc}
- \linenumbers
- \bibliographystyle{amnatnat}
linestretch: 1
link-citations: yes
linkcolor: blue
csl: evolution.csl
biblio-style: apalike
---

**AUTHOR'S NOTE:** This is an initial draft of a potential [brief communcation](https://www.nature.com/natecolevol/about/content) for *Nature Ecology and Evolution*. I think that the take-home message can be expressed in 1500 words. As far as I've been able to find, such an letter would be novel and interesting. The most likely group that would have discovered this already would be the [Allesina lab](https://allesinalab.uchicago.edu/), which works a lot with random matrices, but I've not seen anything about generation time variation published by them. In developing this theory, I also came up with some brief comments on [the effect of increasing numbers of evolutionary traits on eco-evolutionary stability.](#comment_on_Patel), making the simple point after reading @Patel2018 that ecological systems are increasingly likely to be destablised, and unstable ecological systems are decreasingly likely to be stabilised, at higher numbers of evolving species traits.

********************************************************************************

<a name = "working_draft">Variation in generation time drives stability in large random communities</a>
================================================================================

```{r, echo = FALSE}
library(knitr);
dat  <- read.table(file = "mat_dat.csv", header = TRUE, sep = ",");
dat  <- cbind(dat, (dat[,3] - dat[,5]) + dat[,4]);
rownames(dat) <- NULL;
colnames(dat) <- c("Species (S)", "Unstable", "Stable", "Stabilised", 
                   "Destabilised", "Stable ($\\ Var(\u03b3)$ )")
```

********************************************************************************

**Analyses of dynamic systems using random matrices find that stability generally decreases with increasing system size. But in ecological communities, the rate that species densities change as a consequence of species interactions will depend on relative species generation times. Here we show that variation in generation time becomes increasingly important for community stabilisation with increasing community size, and is therefore a potentially key contributor to the stability of large ecosystems.**

********************************************************************************

Understanding the stability and therefore persistence of species rich ecological communities in nature remains a long-standing puzzle in ecology [@Hutchinson1961; @May1972; @Allesina2012; @Grilli2017]. The general conditions under which such communities return to equilibrium densities when perturbed (i.e., are stabilised) are well-established, as is the knowledge that stabilisation becomes increasingly unlikely as community size increases [@May1972]. Recently, analyses of random communities have investigated the effects of community structure, finding, e.g., that predator-prey interactions [@Allesina2012], increasing numbers of species interaction partners [@Allesina2015], correlations between interaction strengths [@Tang2014a], and higher order species interactions can be stabilising [@Allesina2011; @Levine2017]. These investigations assume that the rates at which interacting species affect one another are uniform. But generation times can vary by orders of magnitude between interacting species, causing response time in species dynamics to vary following perturbation. We find that this variation becomes increasingly more likely to stabilise rather than destabilise simulated communities as species number ($S$) increases, and that the probability that community stability is solely caused by variation in generation time is near unity for randomly assembled communities of $S > 10$.

In communities of interacting species, the density of any species $j$ ($N_{j}$) can affect species $i$'s mean fitness ($W_{i}$), and therefore its population growth rate [$N_{i}W_{i}$; @Patel2018]. But the time scale on which species $i$'s growth rate changes ($\gamma_{i}$) in response to the density of another species will vary depending on species $i$'s life history. Short-lived species can experience tens to hundreds of generations during the same time scale that long-lived species experience a single generation. Such timescale differences can have profound consequences for ecological system dynamics [@Hastings2004]. In ecological communities, species with short generation times can be expected to respond more quickly to changes in species densities (higher $\gamma_{i}$), while species with long generation times will respond consistently more slowly (lower $\gamma_{i}$). The relative speed at which the growth rate of species $i$ is affected by a change in the density species of $j$ can therefore be modulated by $\gamma_{i}$ and expressed as $\gamma_{i} \times \partial N_{i}W_{i}/\partial N_{j}$. For large communities, it is convenient to represent these interactions for all $i$ and $j$ pairs using a Jacobian matrix,

$$\boldsymbol{A} = \begin{bmatrix}
    \gamma_{i}\frac{\partial N_{i}W_{i}}{\partial N_{i}}  & \cdots & \gamma_{i}\frac{\partial N_{i}W_{i}}{\partial N_{S}}  \\
    \vdots & \ddots & \vdots \\
    \gamma_{S} \frac{\partial N_{S}W_{S}}{\partial N_{i}}  & \cdots & \gamma_{S} \frac{\partial N_{S}W_{S}}{\partial N_{S}}  \\
\end{bmatrix}.$$

A community is stable if the real components of all eigenvalues of $\boldsymbol{A}$ are negative. 

We examined the stability of 100 million random communities in which $S$ ranged between 2-15 before and after the addition of variation in $\gamma_{i}$. Elements of $\boldsymbol{A}$ were selected from a random uniform distribution $\mathcal{U}\left(-4, 4\right)$, and variation in $\gamma_{i}$ was generated with a random uniform distribution such that $\gamma_{i} = \mathcal{U}\left(1, 1000\right)$ (see [Supporting Information S1](#SI_1)). Random communities were categorised in one of four ways (Table 1): (1) Unstable before and after the addition of variance in $\gamma_{i}$ (unstable), (2) stable before and after the addition of variance in $\gamma_{i}$ (stable), (3) unstable before but not after the addition of variation in $\gamma_{i}$ (stabilised), and (4) stable before but not after the addition of variation in $\gamma_{i}$ (destabilised; Table 1).

We found that as $S$ increases, so does the effect of variation in $\gamma_{i}$ on increasing system stability (Figure 1). At high $S$, nearly all stable communities were only stable due to the effect of variation in $\gamma_{i}$, which rarely destabilised species rich communities ([Supporting Information S1](#SI_2)). All else being equal, variation in generation time therefore becomes more influential in stabilising random communities as community size increases, meaning that variation in generation time might be an important contributor to stability in large communities. 


**References**

<div id="refs"></div>

********************************************************************************

```{r, echo = FALSE, caption = "Stability results from 100 million simulations of random interaction matrices for 2-15 species (S). Columns 2 and 3 report the number of stable and unstable communities in the absence of variation in species generation time (all $\\u03b3 = 1$). Columns 4 and 5 report the number of unstable communities stabilised or stable communities destabilised by $\\ Var(\u03b3)$, respectively. Column 6 reports the total number of communities that are stable given $\\ Var(\u03b3)$ (compare to column 3)."}
kable(dat);
```

**Table 1:** Stability results from 100 million simulations of random interaction matrices for 2-15 species ($S$). Columns 2 and 3 report the number of stable and unstable communities in the absence of variation in species generation time (all $\gamma = 1$). Columns 4 and 5 report the number of unstable communities stabilised or stable communities destabilised by $Var(\gamma)$, respectively. Column 6 reports the total number of communities that are stable given $Var(\gamma)$ (compare to column 3).

********************************************************************************

```{r, echo = FALSE}
bar_dat                      <- t(cbind(dat[,3], dat[,6]));
log_bar_dat                  <- log(bar_dat);
log_bar_dat[log_bar_dat < 0] <- 0;
par(oma = c(4, 4, 1, 4), mar = c(0.5, 0.5, 0.5, 0.5), lwd = 1);
barplot(log_bar_dat, beside = TRUE, col = c("grey60", "grey80"),
        names.arg = dat[,1], ylim = c(0, 25), xlab = "Species number (S)",
        ylab = "Ln number of stable communities", cex.lab = 1.25, 
        cex.axis = 1.25, xlim = c(1, 42), cex.names = 1);
legend("topleft", c("\u03b3 = 1", "\u03b3 = [1, 1000]"), pch=15, 
       col=c("grey60","grey80"), cex = 1.5);
box(lwd = 2);
par(new = TRUE);
y1     <- dat[,4] / (dat[,3] + dat[,4]);
x1     <- seq(from = 2.315, length = 14, by = 0.95)
plot(x = x1, y = y1, xaxt = "n", yaxt = "n", lwd = 2, ylim = c(0, 1),
     xlab = "", ylab = "", type = "b", xlim = c(2, 15), pch = 20, cex = 1.25);
axis(side = 4, at = seq(from = 0, to = 1, by = 0.2), cex.axis = 1.25);
mtext(expression(paste("Species number (S)")), outer = TRUE, side = 1,
      line = 2, cex = 1.25);
mtext(expression(paste("Ln number of stable communities")), outer = TRUE, 
      side = 2, line = 2, cex = 1.25);
mtext(expression(paste("Pr. stable due to Var(",gamma,")")), outer = TRUE, 
      side = 4, line = 2.2, cex = 1.25);
```

**Figure 1:** Stability of random communities when generation time ($\gamma$) varies and when it does not for 2-15 species (x-axis). Bars compare the $\ln$ total number of communities found to be stable out of 100 million before (dark grey) and after (light grey) $Var(\gamma)$ is added to a community (left y-axis). Points show the proportion of these random communities in which stability is a direct consequence of $Var(\gamma)$. 

********************************************************************************

<a name="gen_time_stability">Variation in generation time drives stability in large random communities: Supporting Information S1</a>
--------------------------------------------------------------------------------

********************************************************************************

1. [**Effect of different variation in $\gamma$**](#SI_1)
2. [**Destabilisation with increasing $S$**](#SI_2)
3. [**Code underlying random matrix simulation**](#SI_3)

********************************************************************************

<a name="SI_1">**Effect of different variation in $\gamma$**</a>

Below shows how the amount of variation in generation time (range of $\gamma_{i}$) in a community affects stability. Random communities of $S=8$ species are simulated 1 million times across different magnitudes of variance in $\gamma_{i}$. Random values of $\gamma_{i}$ are chosen for each species $i$ from a uniform distribution $\mathcal{U}\left(1, \max(\gamma_{i})\right)$, where $\max(\gamma_{i})$ ranges from 1 to 100000.

```{r, echo = FALSE, eval = FALSE}
res  <- NULL;
mags <- 10^(0:5);
for(i in mags){
    nn     <- 8;
    A1_stt <- 0;
    A2_stt <- 0;
    iter   <- 10000000;
    while(iter > 0){
        A1_dat  <- runif(n = nn * nn, min = -4, max = 4);
        A1      <- matrix(data = A1_dat, nrow = nn, ncol = nn);
        A2_dat  <- runif(n = nn * nn, min = -4, max = 4);
        A2      <- matrix(data = A2_dat, nrow = nn, ncol = nn);
        gamval  <- runif(n = nn, min = 1, max = i);
        gam_dat <- rep(x = gamval, times = nn);
        gam_mat <- matrix(data = gam_dat, nrow = nn, ncol = nn, byrow = FALSE);
        A2      <- A2 * gam_mat;
        A1_stb  <- max(Re(eigen(A1)$values)) < 0;
        A2_stb  <- max(Re(eigen(A2)$values)) < 0;
        if(A1_stb == TRUE){
          A1_stt <- A1_stt + 1;
        }
        if(A2_stb == TRUE){
          A2_stt <- A2_stt + 1;
        }
        iter    <- iter - 1;
    }
    res <- rbind(res, c(A1_stt, A2_stt));
    print(i);
}
```
```{r, echo = FALSE, eval = TRUE}
mag_var <- read.table(file = "var_gen_mag.csv", header = TRUE, sep = ",");
stabi_3 <- mag_var[,3] / 10000000;
par(mar = c(5, 5, 2, 1));
plot(x = log10(mag_var[,1]), y = stabi_3, type = "b", lwd = 2, ylim = c(0, 0.0005),
     xlab = expression(paste("LOG max(",gamma[i],")")), ylab = "Proportion stable",
     cex.axis = 1.5, cex.lab = 1.5, lty = "solid");
```

Figure S1-1: The proportion of random $S=8$ communities that are stable as $\max(\gamma_{i})$ increases over 5 orders of magnitude. Each point represents a proportion calculated from 1 million random simulated matrices.


Once the generation time varies by an order of magnitude of around 1000, there is little increase in terms of stability. Magnitudes higher than $\gamma_{i} = 1000$ are also likely to be biologically unrealistic for most communities.

********************************************************************************

<a name="SI_2">**Destabilisation with increasing $S$**</a>

Here we use the data from Table 1 in the main text to show that the proportion of already stable communities that are destabilised by the addition of variance in $\gamma_{i}$ decreases with increasing $S$.

```{r, echo = FALSE, eval = TRUE}
par(mar = c(5, 5, 2, 1));
y1 <- dat[,5] / (dat[,2] + dat[,5]);
plot(x = dat[,1], y = y1, type = "b", lwd = 2, ylim = c(0, 0.02),
     xlab = "Species number (S)", 
     ylab = expression(paste("Pr. unstable due to Var(",gamma,")")),
     cex.axis = 1.5, cex.lab = 1.5, lty = "solid");
```

Unstable communities are rarely unstable due to variation in generation time, and as the number of species increases, the probability that unstability will be caused by such variation becomes vanishingly small. Hence, for large communities, variation in generation time might be critical for community stability.

********************************************************************************

<a name="SI_3">**Code underlying random matrix simulation**</a>


```{r}
# Will add code here.
```


********************************************************************************