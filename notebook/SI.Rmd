---
title: "Component response rate variation drives stability in large complex systems"
author: "A. Bradley Duthie"
date: Biological and Environmental Sciences, University of Stirling, Stirling, UK,
  FK9 4LA alexander.duthie@stir.ac.uk
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
  html_document: default
  word_document:
    fig_caption: yes
    pandoc_args:
    - --csl
    - evolution.csl
    reference_docx: docx_template.docx
bibliography: references.bib
header-includes:
- \usepackage{amsmath}
- \usepackage{natbib}
- \usepackage{lineno}
- \usepackage[utf8]{inputenc}
- \linenumbers
- \bibliographystyle{amnatnat}
linestretch: 1
link-citations: yes
linkcolor: blue
csl: nature.csl
subtitle: Supplemental Information
biblio-style: apalike
---

```{r, echo = FALSE}
source(file = "R_old/sim_mat.R");
source(file = "R_old/plot_figs.R");
```

********************************************************************************

**This supplemental information supports the manuscript "Component response rate variation drives stability in large complex systems" with additional analyses to support its conclusions. All text, code, and data underlying this manuscript are publicly available on [GitHub](https://github.com/bradduthie/RandomMatrixStability) as part of the RandomMatrixStability package.**

The [RandomMatrixStability package](https://github.com/bradduthie/RandomMatrixStability) includes all functions and tools for recreating the text, this supplemental information, and running all code; additional documentation is also provided for package functions. The RandomMatrixStability package is available on [GitHub](https://github.com/bradduthie/RandomMatrixStability); to download it, the  [`devtools` library](https://cran.r-project.org/web/packages/devtools/index.html) is needed.

```{r, eval = FALSE}
install.packages("devtools");
library(devtools);
```

The code below installs the RandomMatrixStability package using devtools.

```{r, eval = FALSE}
install_github("bradduthie/RandomMatrixStability");
```


********************************************************************************

Supplemental Information table of contents
================================================================================


- [Stability across increasing $S$](#IncrS) 
- [Stability given targeted manipulation of $\gamma$ (genetic algorithm)](#ga)
- [Stability of ecological networks](#ecological) 
    - [Competitor networks](#competition) 
    - [Mutualist networks](#mutualism) 
    - [Predator-prey networks](#pred-prey) 
- [Sensitivity of connectance (C) values](#connectance)
    - [C = 0.3](#connect3)
    - [C = 0.5](#connect5)
    - [C = 0.7](#connect7)
    - [C = 0.9](#connect9)
- [Large networks of $C = 0.05$ across $S$ and $\sigma$](#sigma)  
    - [$\sigma$ = 0.3](#sigma3)
    - [$\sigma$ = 0.4](#sigma4)
    - [$\sigma$ = 0.5](#sigma5)
    - [$\sigma$ = 0.6](#sigma6)
- [Sensitivity of distribution of $\gamma$](#gam_dist)
- [Feasibility of complex systems](#Feasibility)


Stability across increasing $S$ {#IncrS}
===============================================================================

```{r, echo = FALSE}
dat <- read.csv(file = "sim_results/C_1/random_all.csv");
dat <- dat[,-1]; # Extra row-indicating column removed
```

Figure 3 of the main text reports the number of stable random complex systems found over 1 million iterations. The table below shows the results for all simulations of random $\mathbf{M}$ matrices at $\sigma = 0.4$ and $C = 1$ given a range of $S = \{2, 3, ..., 49, 50\}$. In this table, the `A0` refers to matrices where $\gamma = 1$, while `A1` refers to matrices after $Var(\gamma)$ is added and $\gamma \sim \mathcal{U}(0, 2)$. Each row summarises data for a given $S$ over 1 million randomly simulated $\mathbf{M}$ (`A0` and `A1`). The column `A0_unstable` shows the number of `A0` matrices that are unstable, and the column `A0_stable` shows the number of `A0` matrices that are stable (these two columns sum to 1 million). Similarly, the column `A1_unstable` shows the number of `A1` matrices that are unstable and `A1_stable` shows the number that are stable. The columns `A1_stabilised` and `A1_destabilised` show how many `A0` matrices were stabilised or destabilised, respectively, by $Var(\gamma)$.

```{r, echo = FALSE}
library(knitr);
d_tab <- dat[,1:7];
kable(d_tab);
```

Overall, the ratio of stable `A1` matrices to stable `A0` matrices found is greater than 1 whenever $S > 10$ (compare column 5 to column 3), and this ratio increases with increasing $S$ (column 1). Hence, more randomly created complex systems ($\mathbf{M}$) are stable given variation in $\gamma$ than when $\gamma = 1$. Note that feasibility results were omitted for the table above, but are [reported below](#Feasibility).

Stability given targeted manipulation of $\gamma$ (genetic algorithm) {#ga}
================================================================================

Figure 4 of the main text reports the number of stable random complex systems found over 100000 using the genetic algorithm to maximise stability with a vector $\mathbf{\gamma}$. Stability results for 100000 $\mathbf{M}$ for each $S$ from 2-40 are shown below. Results for `A0` indicate systems in which $\gamma = 1$, while `A1` refers to systems in which the genetic algorithm searched for a set of $\gamma$ values that stabilised the system. 

```{r, echo = FALSE}
get_top_evo_out <- function(evo_out, size){
    highest <- max(evo_out);
    gammas  <- NULL;
    while(size > 0){
        pos <- which(evo_out == highest);
        len <- length(pos);
        nli <- NULL;
        for(i in 1:len){
            start          <- pos[i] + 1;
            end            <- pos[i] + highest;
            gammas[[size]] <- evo_out[start:end];
            size           <- size - 1;
            if(size == 0){
                break;
            }
        }
        highest <- highest - 1;
    }
    return(gammas);
}
plot_evo_out <- function(evo_out){
    gammas <- get_top_evo_out(evo_out, size = 9);
    for(i in 1:9){
        gammas[[i]] <- 2 * gammas[[i]]; # Account for mistake in return
    }
    par(mfrow = c(3, 3), mar = c(0.5, 0.5, 0.5, 0.5), oma = c(5, 5, 1, 1));
    hist(gammas[[1]], main = "", breaks = 20, col = "grey", ylim = c(0, 6),
         xaxt = "n", xlim = c(0, 2.1));
    hist(gammas[[2]], main = "", breaks = 20, col = "grey", ylim = c(0, 6),
         xaxt = "n", yaxt = "n", xlim = c(0, 2.1));
    hist(gammas[[3]], main = "", breaks = 20, col = "grey", ylim = c(0, 6),
         xaxt = "n", yaxt = "n", xlim = c(0, 2.1));
    hist(gammas[[4]], main = "", breaks = 20, col = "grey", ylim = c(0, 6),
         xaxt = "n", xlim = c(0, 2.1));
    hist(gammas[[5]], main = "", breaks = 20, col = "grey", ylim = c(0, 6),
         xaxt = "n", yaxt = "n", xlim = c(0, 2.1));
    hist(gammas[[6]], main = "", breaks = 20, col = "grey", ylim = c(0, 6),
         xaxt = "n", yaxt = "n", xlim = c(0, 2.1));
    hist(gammas[[7]], main = "", breaks = 20, col = "grey", ylim = c(0, 6),
         xlim = c(0, 2.1));
    hist(gammas[[8]], main = "", breaks = 20, col = "grey", ylim = c(0, 6),
         yaxt = "n", xlim = c(0, 2.1));
    hist(gammas[[9]], main = "", breaks = 20, col = "grey", ylim = c(0, 6),
         yaxt = "n", xlim = c(0, 2.1));
    mtext(side = 1, outer = TRUE, line = 3, cex = 1.5,
          text = expression(paste("Component response rate (",gamma,")")));
    mtext(side = 2, text = "Frequency", outer = TRUE, line = 3, cex = 1.5);
}
evo_res <- read.csv(file = "sim_results/evolved/evo_results.csv");
evo_res <- evo_res[,-1];
kable(evo_res);
```

The distributions of nine $\gamma$ vectors from the highest $S$ values are shown below. This comparison shows the high number of stable $\mathbf{M}$ that can be produced through a targeted search of $\gamma$ values, and suggests that many otherwise unstable systems could potentially be stabilised by an informed manipulation of their component response times. Such a possibility might conceivably reduce the dimensionality of problems involving stability in social-ecological or economic systems.

Distributions of $\gamma$ values in vectors for the highest values of $S$ are shown below. 

```{r, fig.height = 4, fig.width = 6, echo = FALSE}
evo_out <- scan(file = "sim_results/evolved/evo_out.txt");
plot_evo_out(evo_out);
```

The distribution of $\gamma$ values found by the genetic algorithm is uniform. A uniform distribution was used to initialise $\gamma$ values, so there is therefore no evidence that a particular distribution of $\gamma$ is likely to be found to stabilise a matrix $\mathbf{M}$. 

Stability of ecological networks {#ecological}
================================================================================

While the foundational work of May[@May1972] applies broadly to complex networks, much attention has been given specifically to ecological networks of interacting species. In these networks, the matrix $\mathbf{A}$ is interpreted as a community matrix and each row and column is interpreted as a single species. The effect that the density of any species $i$ has on the population dynamics of species $j$ is found in $A_{ij}$, meaning that $\mathbf{A}$ holds the effects of pair-wise interactions between $S$ species[@Allesina2012; @Allesina2015]. While May's original work[@May1972] considered only randomly assembled communities, recent work has specifically looked at more restricted ecological communities including competitive networks (all off-diagonal elements of $\mathbf{A}$ are negative), mutualist networks (all off-diagonal elements of $\mathbf{A}$ are positive), and predator-prey networks (for any pair of $i$ and $j$, the effect of $i$ on $j$ is negative and $j$ on $i$ is positive, or vice versa)[@Allesina2012; @Allesina2015]. In general, competitor and mutualist networks tend to be unstable, while predator-prey networks tend to be highly stabilising.

I investigated competitor, mutualist, and predator-prey networks following Allesina et al.[@Allesina2012]. To create these networks, I first generated a random matrix $\mathbf{A}$, then changed the elements of $\mathbf{A}$ accordingly. If $\mathbf{A}$ was a competitive network, then the sign of any positive off-diagonal elements was reversed to be negative. If $\mathbf{A}$ was a mutualist network, then the sign of any positive off-diagonal elements was reversed to be positive. And if $\mathbf{A}$ was a predator-prey network, then all $i$ and $j$ pairs of elements were checked; any pairs of the same sign were changed so that one was negative and the other was positive. 

```{r, echo = FALSE}
species_interactions <- function(mat, type = 0){
    if(type == 1){
        mat[mat > 0] <- -1*mat[mat > 0];
    }
    if(type == 2){
        mat[mat < 0] <- -1*mat[mat < 0];
    }
    if(type == 3){
        for(i in 1:dim(mat)[1]){
            for(j in 1:dim(mat)[2]){
                if(mat[i, j] * mat[j, i] > 0){
                    mat[j, i] <- -1 * mat[j, i];
                }
            }
        }
    }
    return(mat);
} # Note: -1 values are added in the diagonal later
```

The number of stable $\mathbf{M = \gamma A}$ systems was estimated [exactly as it was](#IncrS) in the main text for random matrices for values of $S$ from 2 to 50 (100 in the case of the relatively more stable predator-prey interactions), except that only 100000 random $\mathbf{M}$ were generated instead of 1 million. 

```{r, echo = FALSE}
cdat <- read.csv(file = "sim_results/ecology/competition_C_1.csv");
mdat <- read.csv(file = "sim_results/ecology/mutualism_C_1.csv");
pdat <- read.csv(file = "sim_results/ecology/pred-prey_C_1.csv");
```

The following tables for restricted ecological communities can therefore be compared with the random $\mathbf{M}$ [results above](#IncrS) (but note that counts from systems with comparable probabilities of stability will be an order of magnitude lower in the tables below due to the smaller number of $\mathbf{M}$ matrices generated). As with the [results above](#IncrS), in the tables below, `A0` refers to matrices when $\gamma = 1$ and `A1` refers to matrices after $Var(\gamma)$ is added. The column `A0_unstable` shows the number of `A0` matrices that are unstable, and the column `A0_stable` shows the number of `A0` matrices that are stable (these two columns sum to 100000). Similarly, the column `A1_unstable` shows the number of `A1` matrices that are unstable and `A1_stable` shows the number that are stable. The columns `A1_stabilised` and `A1_destabilised` show how many `A0` matrices were stabilised or destabilised, respectively, by $Var(\gamma)$.

<a name="competition">**Competition**</a>

Results for competitor interaction networks are shown below

```{r, echo = FALSE}
cd_tab <- cdat[,2:8];
kable(cd_tab);
```

<a name="mutualism">**Mutualism**</a>

Results for mutualist interaction networks are shown below

```{r, echo = FALSE}
md_tab <- mdat[,2:8];
kable(md_tab);
```

<a name="pred-prey">**Predator-prey**</a>

Results for predator-prey interaction networks are shown below

```{r, echo = FALSE}
pd_tab <- pdat[,2:8];
kable(pd_tab);
```

Overall, as expected [@Allesina2012], predator-prey communities are relatively stable while mutualist communties are highly unstable. But interestingly, while $Var(\gamma)$ stabilises predator-prey and competitor communities, it does not stabilise mutualist communities. This is unsurprising because purely mutualist communities are characterised by a very positive[@Allesina2012] leading $\Re(\lambda)$, and it is highly unlikely that $Var(\gamma)$ alone will shift all real parts of eigenvalues to negative values.

Sensitivity of connectance (C) values {#connectance}
================================================================================

In the main text, for simplicity, I assumed connectance values of $C = 1$, meaning that all off-diagonal elements of a matrix $\mathbf{M}$ were potentially nonzero and sampled from a normal distribution $\mathcal{N}(0, \sigma^{2})$ where $\sigma = 0.4$. Here I present four tables showing the number of stable communities given $C = \{0.3, 0. 5, 0.7, 0.9 \}$. In all cases, uniform variation in component response time ($\gamma \sim \mathcal{U}(0, 2)$) led to a higher number of stable communities than when $\gamma$ did not vary ($\gamma = 1$). In contrast to the main text, 100000 rather than 1 million $\mathbf{M}$ were simulated. As with the results on [stability with increasing $S$](#IncrS) shown above, in the tables below `A0` refers to matrices when $\gamma = 1$, and `A1` refers to matrices after $Var(\gamma)$ is added. The column `A0_unstable` shows the number of `A0` matrices that are unstable, and the column `A0_stable` shows the number of `A0` matrices that are stable (these two columns sum to 100000). Similarly, the column `A1_unstable` shows the number of `A1` matrices that are unstable and `A1_stable` shows the number that are stable. The columns `A1_stabilised` and `A1_destabilised` show how many `A0` matrices were stabilised or destabilised, respectively, by $Var(\gamma)$.

```{r, echo = FALSE}
C3dat <- read.csv(file = "sim_results/C_other/rand_c-0pt3.csv");
C5dat <- read.csv(file = "sim_results/C_other/rand_c-0pt5.csv");
C7dat <- read.csv(file = "sim_results/C_other/rand_c-0pt7.csv");
C9dat <- read.csv(file = "sim_results/C_other/rand_c-0pt9.csv");
```


<a name="connect3">**Connectance $\mathbf{C = 0.3}$**</a>

```{r, echo = FALSE}
C3dat   <- C3dat[,-1];
C3d_tab <- C3dat[,1:8];
kable(C3d_tab);
```

<a name="connect5">**Connectance $\mathbf{C = 0.5}$**</a>

```{r, echo = FALSE}
C5dat   <- C5dat[,-1];
C5d_tab <- C5dat[,1:8];
kable(C5d_tab);
```

<a name="connect7">**Connectance $\mathbf{C = 0.7}$**</a>

```{r, echo = FALSE}
C7dat   <- C7dat[,-1];
C7d_tab <- C7dat[,1:8];
kable(C7d_tab);
```

<a name="connect9">**Connectance $\mathbf{C = 0.9}$**</a>

```{r, echo = FALSE}
C9dat   <- C9dat[,-1];
C9d_tab <- C9dat[,1:8];
kable(C9d_tab);
```

Sensitivity of interaction strength ($\sigma$) values {#sigma}  
================================================================================

Results below show stability results given varying interaction strengths ($\sigma$) for $C = 0.05$ (note that system size $S$ values are larger and increase by 10 with increasing rows). In the tables below (as [above](#IncrS)), `A0` and `A1` refers to matrices for $\gamma = 1$ and $Var(\gamma)$, respectively.


```{r, echo = FALSE}
S3dat <- read.csv(file = "sim_results/C_0pt05/sim_SD_0pt3.csv");
S4dat <- read.csv(file = "sim_results/C_0pt05/sim_SD_0pt4.csv");
S5dat <- read.csv(file = "sim_results/C_0pt05/sim_SD_0pt5.csv");
S6dat <- read.csv(file = "sim_results/C_0pt05/sim_SD_0pt6.csv");
```

<a name="sigma3">**Interaction strength $\mathbf{\sigma = 0.3}$**</a>

```{r, echo = FALSE}
S3dat   <- S3dat[,-1];
S3d_tab <- S3dat[,1:7];
kable(S3d_tab);
```

<a name="sigma4">**Interaction strength $\mathbf{\sigma = 0.4}$**</a>

```{r, echo = FALSE}
S4dat   <- S4dat[,-1];
S4d_tab <- S4dat[,1:7];
kable(S4d_tab);
```

<a name="sigma5">**Interaction strength $\mathbf{\sigma = 0.5}$**</a>

```{r, echo = FALSE}
S5dat   <- S5dat[,-1];
S5d_tab <- S5dat[,1:7];
kable(S5d_tab);
```

<a name="sigma6">**Interaction strength $\mathbf{\sigma = 0.6}$**</a>

```{r, echo = FALSE}
S6dat   <- S6dat[,-1];
S6d_tab <- S6dat[,1:7];
kable(S6d_tab);
```


Sensitivity of distribution of $\gamma$ {#gam_dist}
================================================================================

In the main text, I considered a uniform distribution of component response rates $\gamma \sim \mathcal{U}(0, 2)$. The number of unstable and stable $\mathbf{M}$ matrices are reported in [a table above](#IncrS) across different values of $S$. Here I show complementary results for three different distributions including an exponential, beta, and gamma distribution of $\gamma$ values. The shape of these distributions is shown in the figure below.

********************************************************************************

**Distributions of component response rate ($\boldsymbol{\gamma}$) values in complex systems.** The stabilities of simulated complex systems with these $\gamma$ distributions are compared to otherwise identical complex systems with a fixed component response rate of $\gamma = 1$ across different system sizes ($S$; i.e., component numbers) given a unit $\gamma$ standard deviation ($\sigma_{\gamma} = 1$) for b-d. Distributions are as follows: (a) uniform, (b) exponential, (c) beta ($\alpha = 0.5$ and $\beta = 0.5$), and (d) gamma ($k = 2$ and $\theta = 2$). Each panel shows 1 million randomly generated $\gamma$ values.

```{r, eval = TRUE, echo = FALSE, fig.height = 7, fig.width = 6}
make_gammas <- function(nn = 10, distribution = 1, mn = 1, sdd = 1){
    if(distribution == 0){
        dat          <- rep(x = mn, times = nn);
    }
    if(distribution == 1){
        mval         <- 2;
        dat          <- runif(n = nn, min = 0, max = mval);
    }
    if(distribution == 2){
        dat          <- rexp(n = nn);
        dat          <- sdd * ((dat - mean(dat)) / sd(dat));
        dat          <- dat - min(dat) + min(abs(dat));
    }
    if(distribution == 3){
        dat          <- rbeta(n = nn, shape1 = 0.5, shape2 = 0.5);
        dat          <- sdd * ((dat - mean(dat)) / sd(dat));
        dat          <- dat - min(dat) + min(abs(dat));
    }
    if(distribution == 4){
        dat          <- rgamma(n = nn, shape = 2, scale = 2);
        dat          <- sdd * ((dat - mean(dat)) / sd(dat));
        dat          <- dat - min(dat) + min(abs(dat));
    }
    return(dat);
}

show_gammas <- function(nn = 1000000, sdd = 1, mn = 10){
    y1 <- make_gammas(nn = nn, distribution = 1, sdd = sdd, mn = mn);
    y2 <- make_gammas(nn = nn, distribution = 2, sdd = sdd, mn = mn);
    y3 <- make_gammas(nn = nn, distribution = 3, sdd = sdd, mn = mn);
    y4 <- make_gammas(nn = nn, distribution = 4, sdd = sdd, mn = mn);
    par(mfrow = c(2, 2), oma = c(6, 6, 1, 1), mar = c(4, 0.5, 0.5, 0.5));
    h1 <- hist(y1, breaks = 1000, plot = FALSE);
    hist(y1, breaks = 1000, yaxt = "n", main = "", xlab = "", cex.axis = 1.5,
         ylim = c(0, max(h1$counts)*1.2));
    mtext("a", adj = 0, line = -2.3, cex = 2, 
          at = par("usr")[1]+0.90*diff(par("usr")[1:2]));
    box();
    h2 <- hist(y2, breaks = 1000, plot = FALSE);
    hist(y2, breaks = 1000, yaxt = "n", main = "", xlab = "", cex.axis = 1.5,
         ylim = c(0, max(h2$counts)*1.2));
    mtext("b", adj = 0, line = -2.3, cex = 2, 
          at = par("usr")[1]+0.90*diff(par("usr")[1:2]));
    box();
    h3 <- hist(y3, breaks = 1000, plot = FALSE);
    hist(y3, breaks = 1000, yaxt = "n", main = "", xlab = "", cex.axis = 1.5,
         ylim = c(0, max(h3$counts)*1.2));
    mtext("c", adj = 0, line = -2.3, cex = 2, 
          at = par("usr")[1]+0.90*diff(par("usr")[1:2]));
    box();
    h4 <- hist(y4, breaks = 1000, plot = FALSE);
    hist(y4, breaks = 1000, yaxt = "n", main = "", xlab = "", cex.axis = 1.5,
         ylim = c(0, max(h4$counts)*1.2));
    mtext("d", adj = 0, line = -2.3, cex = 2, 
          at = par("usr")[1]+0.90*diff(par("usr")[1:2]));
    box();
    mtext(expression(paste("Component ",gamma," value")),
          outer=TRUE,side=1,line=3.0,cex=2);
    mtext(expression(paste("Relative frequency")),
          outer=TRUE,side=2,line=2.5,cex=2);
}

show_gammas();
```

********************************************************************************

The same 100000 $\mathbf{M}$ matrices were used to investigate stability when applying each of these different distributions of $\gamma$ values. The table below shows the number of $\mathbf{M}$ that were unstable (_unst) and stable (_stbl) for the exponential (Exp), beta, and gamma distributions.

```{r, echo = TRUE}
fourdists <- read.csv(file = "sim_results/different_distr/four_distr_rand.csv");
kable(fourdists);
```

In comparison to the uniform distribution (a), proportionally fewer random systems are found with the exponential distribution (b), while more are found with the beta (c) and gamma (d) distributions.

Feasibility of complex systems {#Feasibility}
================================================================================

When feasibility was evaluated with and without variation in $\gamma$, there was no increase in stability for $\mathbf{M}$ where $\gamma$ varied as compared to where $\gamma = 1$. Results below illustrate this result, which was general to all other simulations performed. 

```{r, echo = FALSE}
dat      <- read.csv(file = "sim_results/C_1/random_all.csv");
dat      <- dat[,-1]; # Extra row-indicating column removed
feas_tab <- cbind(dat[,1], dat[,8:13]);
colnames(feas_tab)[1] <- "S";
kable(feas_tab);
```

Hence, in general, $Var(\gamma)$ does not appear to affect feasibility in pure species interaction networks.


References
================================================================================

