---
title: 'Biodiversity and ecosystem function in ephemeral patches: some theory ideas'
author: "Brad Duthie"
bibliography: references.bib
output:
  html_document: default
  pdf_document:
    fig_caption: yes
  word_document:
    fig_caption: yes
    pandoc_args:
    - --csl
    - evolution.csl
    reference_docx: docx_template.docx
header-includes:
- \usepackage{amsmath}
- \usepackage{natbib}
- \usepackage{lineno}
- \usepackage[utf8]{inputenc}
- \linenumbers
- \bibliographystyle{amnatnat}
linestretch: 1
link-citations: yes
linkcolor: blue
csl: evolution.csl
biblio-style: apalike
---


> "If increasing clutch size leads to losses through sib competition, it becomes optimal to compensate by reducing the time spent gathering resources for the clutch of eggs, leading to a smaller clutch (egg size times number) and also by laying larger (and hence even fewer) eggs" [@Parker1986].

[Parker's citations](https://scholar.google.co.uk/scholar?cites=12394960503460892627&as_sdt=2005&sciodt=0,5&hl=en)


Brief introduction to the model and parameters
--------------------------------------------------------------------------------

Define the relationship between total investment budget $M$, parental investment (PI) $m_{i}$ (i.e., the investment that each offspring receives), and total offspring produced $n_{i}$, as follows,

$$n_{i} = \frac{M_{i}}{m_{i}}.$$

Define the effect of competition of the offspring of $j$ on the offspring of $i$ as follows,

$$\alpha_{ij}(m_j, n_j) = \frac{m_{j}n_{j}}{R}.$$

In the above, $R$ defines the total available resources on a patch. The fitness of an individual $i$ ($W_{i}$), defined by number of *viable* offspring produced, will be the product of offspring produced $n_{j}$ and the viability of each offspring, as affected by parental investment $m_{i}$ and effects of competition $\alpha_{ij}(m_j, n_j)$ summed over all competitors $j$<sup><a name="note_1">note_1</a></sup>,

$$W_{i} = \left(1 - e^{-c\left(m_{i} - m_{min} - \sum_{j = 1}^{N}\alpha_{ij}(m_{j}, n_{j})\right)}\right).$$

In the above, $m_{min}$ is a minimum amount of investment required to produce a viable offspring. The parameter $c$ defines the shape of the curve relating parental investment to viability (i.e., how 'diminishing' are the returns in fitness $W_{i}$ as $m_{i}$ increases). From the above equation, it is possible to figure out how much parental investment is optimal ($m^{*}_{i}$) for an individual $i$.

- **[note_1](#note_1):** I [originally had this](https://github.com/bradduthie/dungfly/commit/0b5e10f6fe57911c2d701fc647e26c3baeda55d8) as just $m_{j}R^{-1}$, but this confuses what $N$ really is, as I think it should be the competitors arriving at a patch, not the offspring that they produce; hence, more competitors, more offspring, and this needs to be reflected in the equation. Also note, of course, $m_{j}n_{j} = M_{j}$. @Parker1986 go a different route here, choosing to look at survival given competition as a function of only $n_{j}$ and ignoring effects of increased $m_{j}$ on competition, reasoning that competition should typically "become important only after a considerable amount of growth beyond the egg stage has occurred". I am including both $n_{j}$ and $m_{j}$ to increase the generality, and because I think that in many systems, this assumption might be violated.

Also, it is worth acknowledging that I've [used this mathematical trick before](https://bradduthie.github.io/DuthieEtAl2016c.pdf) in the context of inbreeding [@Duthie2016b], so I'm mostly building off of the hope that a lot of the same logic can apply to decreases in fitness from competitive effects #overlyhonestmethods.

Tedious maths to get optimal parental investment
--------------------------------------------------------------------------------

**This section can be skipped** for anyone who is not interested in how to derive $m^{*}_{i}$ from the equation for $W_{i}$, but I need the equations and code for the concrete example.

```{r, echo = TRUE}
alpha_ij <- function(mi, R) sum(mi/R); # Note: using 'cc' to avoid confusing 'c()'.
W_i      <- function(mi, cc, mmin, mj, R) (1 - exp(-cc*(mi - mmin - alpha_ij(mj,R))));
fWi      <- expression((1-exp(-cc*(mi-mmin-Alpha))),'mi');
dfWi     <- D(fWi, 'mi');
```

For simplicity, we can define $m_{min} = 1$, so unity is the minimum amount of parental investment required to produce a viable offspring in the absence of competition.  For simplicity, we can also set $c = 1$. In the absence of competition (as $R \to \infty$), we have the following slope.

```{r, echo = TRUE}
m_vals <- seq(from = 0, to = 6, length = 1000);
viable <- W_i(c = 1, mi = m_vals, mmin = 1, mj = 1, R = Inf);
par(mar = c(5, 5, 2, 1));
plot(x = m_vals, y = viable, type = "l", lwd = 3, 
     xlab = expression(paste("Parental Investment (",italic(m),")")),
     ylab = expression(paste("Individual fitness (",italic(W[i]),")")),
     cex.lab = 1.5, cex.axis = 1.5, xaxs="i", yaxs="i", ylim = c(0,1));
```



The optimal parental investment $m_{i}^{*}$ is obtained by finding the line tangent to the curve that passes through the origin; the point where the curve and this line meet defines $m_{i}^{*}$ because it maximises the rate at which viable offspring are produced. To get the tangent line, we first need to get the derivative of $W_{i}$ with respect to $m_{i}$,

$$\frac{\partial W_{i}}{\partial {m_{i}}} = ce^{-c\left(m_i - m_{min} - \sum_{j = 1}^{N}\alpha_{ij}(m_{j}, n_{j}) \right)}.$$

A function for the above is below,

```{r, echo = TRUE}
dW_i <- function(mi, cc, mmin, mj, R) cc * exp(-cc * (mi - mmin - alpha_ij(mj, R)));
```

In general, the equation for any line that is tangent to a function $f$ (with derivative $f'$) at the point $a$ is,

$$y = f'(a)(x - a) + f(a).$$

Because we want to pass through the origin where $x = 0$ and $y = 0$, we use the following to describe the tangent line above,

$$0 = ce^{-c(m_i - m_{min} - \sum_{j = 1}^{N}\alpha_{ij}(m_{i}))}(0 - m_{i}) + \left(1 - e^{-c\left(m_{i} - m_{min} - \sum_{j = 1}^{N}\alpha_{ij}(m_{j}, n_{j})\right)}\right).$$

We can just solve this numerically for the parameters set in finding `viable` above. Below is a quick function to get $m_{i}^{*}$.

```{r, echo = TRUE}
get_mi <- function(low_guess, high_guess, cc = 1, mmin = 1, mj = 1, R = Inf){
    fm <- function(mi, cc = cc, mmin = mmin, mj = mj, R = R){
        W_val <- W_i(mi = mi, cc = cc, mmin = mmin, mj = mj, R = R);
        W_der <- dW_i(mi = mi, cc = cc, mmin = mmin, mj = mj, R = R);
        return( W_der*(0-mi) + W_val );
    }
    lg  <- fm(mi = low_guess, cc = cc, mmin = mmin, mj = mj, R = R);
    hg  <- fm(mi = high_guess, cc = cc, mmin = mmin, mj = mj, R = R);
    if(lg > 0){
      u <- low_guess;
      l <- high_guess;
    }else{
      u <- high_guess;
      l <- low_guess;
    }
    fml <- fm(mi = l, cc = cc, mmin = mmin, mj = mj, R = R);
    fmu <- fm(mi = u, cc = cc, mmin = mmin, mj = mj, R = R);
    if((fml > 0 & fmu > 0) | (fml < 0 & fmu < 0)){
      return("Value of m is outside the range");
    }else{
      check  <- 1;
      mguess <- 0.5 * (l+u);
      i      <- 0;
      while(abs(check) > 0.000001 & i < 1000000){
          check <- fm(mi = mguess, cc = cc, mmin = mmin, mj = mj, R = R);
          if(check > 0){
            u      <- mguess;
            mguess <- 0.5*(l + mguess); 
          }else{
            l      <- mguess;
            mguess <- 0.5*(u + mguess);
          }
          i <- i+1;
      }
    return(mguess);
  }
} # Running the below returns the estimate
m_star <- get_mi(low_guess = 0, high_guess = 6, cc = 1, mmin = 1, mj = 1, R = Inf);
```

Running the above code gets an $m_{i}^{*}$ <a name="m_star-no_comp">value</a> of `r m_star`. We can plot the tangent line on the function using the code below.

```{r, echo = TRUE}
m_vals <- seq(from = 0, to = 6, length = 1000);
viable <- W_i(c = 1, mi = m_vals, mmin = 1, mj = 1, R = Inf);
par(mar = c(5, 5, 2, 1));
plot(x = m_vals, y = viable, type = "l", lwd = 3, 
     xlab = expression(paste("Parental Investment (",italic(m),")")),
     ylab = expression(paste("Individual fitness (",italic(W[i]),")")),
     cex.lab = 1.5, cex.axis = 1.5, xaxs="i", yaxs="i", ylim = c(0,1));
slope_mstar <- W_i(mi = m_star, cc = 1, mmin = 1, mj = 1, R = Inf) / m_star;
abline(a = 0, b = slope_mstar, lty = "dotted", lwd = 2);
```

Where am (was) I going with all of this?
--------------------------------------------------------------------------------

I've removed all competition in the tedious maths bits above by setting $R = \infty$ so that resources are limitless and the offspring of parents feed without restriction. Note that there is still an optimum parental investment *above the minimum* because the viability of the offspring is affected by parental investment *independent of competition* -- this could be something like the probability of being able to fight off pathogens or persevere through abiotic stress (i.e., some component of fitness that is independent of density). Now, I want to **see what happens when competition decreases viability**. Given finite resources, assume that parental investment $m_{i}$ influences both competitive ability and viability independent of competition (e.g., something like body size or feeding rate). **It seems intuitive that if competition is high, then it might increase fitness to increase investment to produce fewer competitive offspring**. Note that this also assumes a situation in which an individual moving to a different patch to oviposit is either not possible, or is costly (i.e., at least more costly than it would be to stay and invest optimally on the current patch). 

The [corrected version](https://github.com/bradduthie/dungfly/commit/e81c673a78e60e3c95038976129d190cfd5956fd
) of $\alpha_{ij}(m_j, n_j)$ to include $n_{j}$ should make things easier by recognising that *total* competition should depend on the total investment budgets of the individuals arriving to a patch to oviposit. In other words, total competition does not depend on the parental investment decisions of other individuals -- at least not yet. This type of recursion (in which, e.g., competition changed with *realised* viability given different parental investment) is just going to be too complicated of a starting point, so it is better to first consider **how optimal parental investment, and therefore offspring number, is modified by existing competitors on a patch**, without thinking about feedbacks that follow. In a more formal analysis, it might be interesting to consider the PI decisions for an initial coloniser of a patch, followed by the decision of the second arriver, and a third, and so forth. This would link with the established literature optimal foraging and oviposition per patch somehow, which has been studied in ovipositing wasps, though not (to my knowledge), in the context of parental investment where individuals might adjust allocation of resources to eggs or modify behaviour (e.g., guarding).

A simple, concrete example to get started
--------------------------------------------------------------------------------

I will begin with an example of a single ovipositing female on a patch of resources where $R = 100$. The female has a total investment budget of $M_{i} = 10$. Conveniently, the way $\alpha_{ij}(m_j, n_j) = m_{j}n_{j}{R^{-1}}$ is defined allows to just substitute $M_{j} = m_{j}n_{j} = 10$, so $\alpha_{ij}(m_j, n_j) = M_{j}R^{-1} = 10R^{-1} = 0.1$. We can start working from the general equation,

$$W_{i} = \left(1 - e^{-c\left(m_{i} - m_{min} - \sum_{j = 1}^{N}\alpha_{ij}(m_{j}, n_{j})\right)}\right).$$

And we can substitute in the relevant values for competition; assume $c = 1$ and $m_{min} = 1$ for simplicity,

$$W_{i} = \left(1 - e^{-\left(m_{i} - 1 - 0.1\right)}\right).$$

If a focal female's fitness $W_{i}$ is **not** decreased by competition among her offspring, then we had a optimal PI $m^{*}_{i}$ of `r m_star`, [as above](#m_star-no_comp). Now that we have added some competition among her offspring, optimal PI per offsrping is calculated with the code below.
                   
```{r, echo = TRUE}
m_star_1 <- get_mi(low_guess = 0, high_guess = 6, cc = 1, mmin = 1, mj = 10, R = 100);
```                   
                   
The value of `m_star_1`, and optimal PI $m^{*}_{i}$ given competition amongst offspring is therefore `r m_star_1`, a value that is **higher than optimal PI in the absence of competition**.
                   
Okay, now let's consider what happens when the next competitor arrives *immediately after the first* to oviposit (i.e., ignore any priority effects for now). Assume that she notices that the first competitor is there and can adjust her PI accordingly. If her own total investment budget is also 10, then $\sum_{j = 1}^{N}\alpha_{ij}(m_{j}, n_{j}) = (10 + 10)/100 = 0.2$. We can do the same exercise as before to figure out *her* optimal parental investment.
                   
```{r, echo = TRUE}
m_star_2 <- get_mi(low_guess = 0, high_guess = 6, cc = 1, mmin = 1, mj = c(10, 10), R = 100);
```                 
                   
The value of `m_star_2` given this increased competition is now `r m_star_2`. Continuing with this logic, we can see how optimal parental investment changes with up to 100 arriving competitors.

```{r, echo = TRUE}
m_stars  <- NULL;
tot_comp <- 1:100;
for(competitors in tot_comp){
    mjs     <- rep(x = 10, times = competitors)
    m_star  <- get_mi(low_guess = 0, high_guess = 20, cc = 1, 
                      mmin = 1, mj = m_stars, R = 100);
    m_stars <- c(m_stars, m_star);
}
par(mar = c(5, 5, 2, 1));
plot(x = tot_comp, y = m_stars, type = "l", pch = 20, lwd = 3, 
     xlab = "Number of competitors on a patch",
     ylab = expression(paste("Optimal parental investment (","m*"[i],")")),
     cex.lab = 1.5, cex.axis = 1.5);
```
                   
This seems like a substantial change in optimal parental investment when competition affects offspring survival, but can be mitigated with increasing PI. Note that total offspring produced per competitor also changes in accordance with $n_{i} = M_{i}m_{i}^{-1}$.
                   
```{r, echo = TRUE}
n_prod <- 10 / m_stars;
par(mar = c(5, 5, 2, 1));
plot(x = tot_comp, y = n_prod, type = "l", pch = 20, lwd = 3, 
     xlab = "Number of competitors on a patch",
     ylab = expression(paste("Offspring per competitor (","n"[i],")")),
     cex.lab = 1.5, cex.axis = 1.5);
```

Given the assumptions underlying this model, it does not seem unreasonable to expect fairly substantial decreases in how an individual arriving to a patch chooses to allocate from their total investment budget $M_{i}$.

Key thoughts before looking at eco-evo feebacks
--------------------------------------------------------------------------------
                   
**It is important to recognise that decreased offspring production as a consequence of shifting parental investment *is* competition in a community ecology sense.** If, for example, a focal individual ultimately *increases* their fitness by producing fewer viable offspring, competition has still occurred. Further, if a focal individual decreases the number of offspring that they produce due to increasd density of other individuals, then competition has occurred **even if those other competitors fail to produce offspring** (e.g., due to sterility). This is because competition is simply defined as an interaction in which the density of a species $i$ decreases the growth rate of a species $j$ (including where $i = j$). Using absolute competition coefficients $\alpha_{ij}$ describing the total effect of species $j$ on species $i$, this is described by the following equation [@Chesson2000b],

$$\frac{dN_{i}}{dt} = r_{i}N_{i}\left(1 - \sum \alpha_{ij}N_{j}\right).$$

In the above, $N$ defines species densities and $r$ is the intrinsic rate of growth in the absence of competition. Competition is merely defined by the presence of a species $j$ ($N_{j}$) on the growth rate of species $i$ (and vice versa); no particular mechanism is assumed. If more $j$ causes focal individuals to shift towards producing fewer $i$, then competition has occurred, though this is counterintuitive. The term **"intimidation competition"** seems appropriate, and apparently [has not been coined in the literature](https://scholar.google.co.uk/scholar?hl=en&as_sdt=0%2C5&q=ecology+%22intimidation+competition%22&btnG=). I'll need to dig a bit more to see if the general concept has been pointed out already.




Different competition functions
--------------------------------------------------------------------------------
                   
I have only looked at a simple competition function,

$$\alpha_{ij}(m_j, n_j) = \frac{m_{j}n_{j}}{R}.$$

But this might be an unrealistic assumption. For example, allocating twice the parental investment to half the number of offspring will result in an identical $\alpha_{ij}(m_j, n_j)$, but it might be that competition is not linearly related to the product of $m_j$ and $n_j$. Rather, twice as much PI in half as many offspring might increase (or decrease) the total value of $\alpha_{ij}(m_j, n_j)$. We can modify the effect of each $m_j$ and $n_j$ on competition using the exponents $a$ and $b$,

$$\alpha_{ij}(m_j, n_j) = \frac{m_{j}^{a}n_{j}^{b}}{R}.$$

If $a = 1$ and $b = 1$, then $\alpha_{ij}(m_j, n_j)$ remains constant as $m_{j}^{a}$ varies (because $M_{j} = m_{j}n_{j}$; see solid line below). If, e.g., $a = 2$ and $b = 1/2$, then $\alpha_{ij}(m_j, n_j)$ increases with increasing parental investment $m_{j}$ of competitors (see dashed line below). If, e.g., $a = 1/2$ and $b = 2$, then $\alpha_{ij}(m_j, n_j)$ decreases with increasing parental investment $m_{j}$ of competitors (see dotted line below). 

```{r, echo = TRUE}
M_j     <- 10;
aij_exp <- function(mj, nj, a, b, R = 100) ((mj^a) * (nj^b)) / R;
mj_vals <- seq(from = 0, to = 6, length = 1000);
comp_1  <- aij_exp(mj = mj_vals, nj = M_j/mj_vals, a = 1,   b = 1,   R = 100);
comp_2  <- aij_exp(mj = mj_vals, nj = M_j/mj_vals, a = 2,   b = 0.5, R = 100);
comp_3  <- aij_exp(mj = mj_vals, nj = M_j/mj_vals, a = 0.5, b = 2,   R = 100);
par(mar = c(5, 5, 2, 1));
plot(x = mj_vals, y = comp_1, type = "l", lwd = 2, ylim = c(0, 1),
     xlab = "Parental investment of competitors", ylab = "Total competition on offspring",
     cex.axis = 1.5, cex.lab = 1.5);
points(x = mj_vals, y = comp_2, type = "l", lty = "dashed", lwd = 2);
points(x = mj_vals, y = comp_3, type = "l", lty = "dotted", lwd = 2);
```

While the general result that optimal parental investment increases with increasing competition should not change, just how much competition is predicted to change as a result of changes in parental investment might therefore depend on how competition is affected differently by changes to $m_{j}$ versus $n_{j}$. **This might have interesting consequences for community ecology** and ecological and evolutionary feedbacks more generally, in that changes in PI could increase or decrease population growth, which could in turn affect changes in PI through changing species densities.

Eco-evolutionary approach to species coexistence
--------------------------------------------------------------------------------

To advance theory further, I would like to determine what effect the modulation of parental investment (and therefore offspring number) has on population dynamics and therefore species coexistence. I will use the recently developed approach of @Patel2018 to investigate how feedbacks affect community stability. We can consider a simple eco-evo case of two species, $i$, and $j$ (note that I'm indexing *species* now, not individuals as before), in which species densities $N_{i}$ and $N_{j}$ change and species $i$ parental investment trait $m_{i}$ evolves. **Note that** in contrast to previous models such as @Parker1986, it is not assumed tha PI is adjusted with phenotypic plasticity, but evolves as a quantitative trait. The total effect of ecology and evolution is defined by the Jacobian matrix $\boldsymbol{J}$,

$$\boldsymbol{J} = \begin{bmatrix}
    \boldsymbol{A}  & \boldsymbol{B}  \\
    \boldsymbol{C}  & \boldsymbol{D}  \\  \end{bmatrix}
    = \begin{bmatrix}
    \frac{\partial N_{i}W_{i}}{\partial N_{i}}  & \frac{\partial N_{i}W_{i}}{\partial N_{j}} & \frac{\partial N_{i}W_{i}}{\partial m_{i}} & \frac{\partial N_{i}W_{i}}{\partial m_{j}}  \\
    \frac{\partial N_{j}W_{j}}{\partial N_{i}}  & \frac{\partial N_{j}W_{j}}{\partial N_{j}} & \frac{\partial N_{j}W_{j}}{\partial m_{i}} & \frac{\partial N_{j}W_{j}}{\partial m_{j}} \\
    \varepsilon\frac{\partial m_{i}}{\partial N_{i}}  & \varepsilon\frac{\partial m_{i}}{\partial N_{j}} & \varepsilon\frac{\partial m_{i}}{\partial m_{i}} & \varepsilon\frac{\partial m_{i}}{\partial m_{j}}  \\
    \varepsilon\frac{\partial m_{j}}{\partial N_{i}}  & \varepsilon\frac{\partial m_{j}}{\partial N_{j}} & \varepsilon\frac{\partial m_{j}}{\partial m_{i}} & \varepsilon\frac{\partial m_{j}}{\partial m_{j}}  \\
\end{bmatrix}.$$

As in @Patel2018, we can consider the sign of $\boldsymbol{J}$ elements to infer how evolution and ecology interact to affect overall stability. Note also that the value $\varepsilon$ defines the rate of evolution relative to ecology [@Patel2018]. Also note that I am including both traits $m$ and $n$ into the matrix explicitly rather than simply using $m$; this is important more for maths reasons than anything else (we need to be able to invert a matrix later, and having two negatively correlated traits allows us to do this). I am going to start by assuming a simple competition function and showing why that it cannot affect eco-evolutionary dynamics,

$$\alpha_{ij}(m_j, n_j) = \frac{m_{j}n_{j}}{R}.$$

The above function of competition means that there should be **no direct trait change effects on ecology** (e.g., $\partial N_{i}W_{i} / \partial m_{i}$ because the total growth rate *in terms of expected viable offspring* $N_{i}W_{i}$ will not change with $m_j$ because it will be exactly balanced by a change in $n_j$ to define competitive effects. If this is true, then there will be no ultimate effect of competition on the stability of the system overall. Conceptually, this is because evolutionary traits do not feed back at all to affect the ecology of the system -- i.e., everything is driven by the stability of the ecology. Mathematically, this is due to multiplying all values of the resulting $\boldsymbol{B}$ (which is either a matrix or vector of zeroes) to obtain the stability criteria with feedbacks. Hence, eco-evolutionary feedbacks should *only* be important for the more general case where tradeoff in parental investment and offspring number does not produce equivalent results for competition,

$$\alpha_{ij}(m_j, n_j) = \frac{m_{j}^{a}n_{j}^{b}}{R}.$$

For evolution to *have a direct effect on ecology*, at least one of the exponents $a$ or $b$ needs to be inequal to 1. Below I consider four separate cases that include relatively slow and fast evolution of traits given different effects of $m$ and $n$ on competition.



General derivation of PI affected by competition
--------------------------------------------------------------------------------

**This section can be skipped** for anyone who does not need convincing that optimal parental investment $m^{*}_{i}$ will increase with an increase in competition more generally. To demonstrate this is the case, we need to show that $\partial m^{*}_{i} / \partial{\alpha_{ij}(m_j, n_j)}$ for a wide range of conditions. Assume that $\alpha_{ij}(m_j, n_j)$ is positive. We can then start with the general equation for which $m_{i} = m^{*}_{i}$,

$$0 = ce^{-c(m_i - m_{min} - \sum_{j = 1}^{N}\alpha_{ij}(m_{i}))}(0 - m_{i}) + \left(1 - e^{-c\left(m_{i} - m_{min} - \sum_{j = 1}^{N}\alpha_{ij}(m_{j}, n_{j})\right)}\right).$$

Substituting $m^{*}_{i}$ for $m_{i}$, we have the following,

$$0 = -m^{*}_{i}ce^{-c(m^{*}_{i} - m_{min} - \sum_{j = 1}^{N}\alpha_{ij}(m^{*}_{i}))} + 1 - e^{-c\left(m^{*}_{i} - m_{min} - \sum_{j = 1}^{N}\alpha_{ij}(m_{j}, n_{j})\right)}.$$

```{r, echo = FALSE, eval = FALSE}
library("Ryacas"); # The Ryacas library can simplify
yacas("Solve(0 == -mi * cc * Exp(-cc*(mi - mmin - aij)) + 1 - Exp(-cc*(mi - mmin - aij)), aij)");
```

Just to keep the notation simpler for a moment, allow,

$$\alpha_{ij}(m_{j}, n_{j}) \equiv \sum_{j = 1}^{N}\alpha_{ij}(m_{j}, n_{j}).$$

We can isolate $\alpha_{ij}(m_{j}, n_{j})$ algebraically from the above (the package [Ryacas](https://cran.r-project.org/package=Ryacas) is useful here).

$$\alpha_{ij}(m_{j}, n_{j}) = m^{*}_{i} - m_{min} + \frac{1}{c}\log\left(\frac{1}{m^{*}_{i}c+1}\right).$$

From here, we can differentiate $\alpha_{ij}(m_{i})$ with respect to $m_{i}^{*}$.

```{r, echo = TRUE}
fWi_opt     <- expression((mi - mmin + (1/cc)*log(1/(mi * cc + 1))), 'mi');
dfWi_opt    <- D(fWi_opt, 'mi');
```

The result is as follows,

$$\frac{\partial \alpha_{ij}(m_{j}, n_{j})}{\partial m_{i}^{*}} = 1 - \frac{c(m_{i}^{*}c + 1)}{c(m_{i}^{*}c + 1)^2}.$$

This actualy simplifies nicely to the following (double-checked with R and [mathomatic](http://mathomatic.orgserve.de/math/)),

$$\frac{\partial \alpha_{ij}(m_{j}, n_{j})}{\partial m_{i}^{*}} = \frac{m_{i}^{*}c}{m_{i}^{*}c + 1}.$$

And via the [chain rule](https://en.wikipedia.org/wiki/Chain_rule) of calculus, we can do the following,

$$\frac{\partial m_{i}^{*}}{\partial \alpha_{ij}(m_{j}, n_{j})} = \frac{m_{i}^{*}c + 1}{m_{i}^{*}c}.$$

Overall, for any $m_{i}^{*} > 0$ and $c > 0$ (parental investment increases offspring viability), optimal parental investment will increase with increasing competition. We can therefore conclude that this relationship is general in that the specific form of the competition function does not matter as long as competition decreases offspring viability, nor does the value of $m_min$. **It is potentially interesting to note** that if $\alpha_{ij}(m_{j}, n_{j}) < 0$ (mutualism or facilitation), then optimal parental investment should actually decrease with increasing density of other individuals, ultimately producing more offspring.

It is worth noting that the above corresponds to equation 4 in @Parker1986.

Empirical predictions
--------------------------------------------------------------------------------

One potentially interesting way to test this could be by looking for the *intimidation competition* that I mentioned earlier. As an example, we can imagine a focal female arriving at a patch to oviposit (though any individual that reproduces in an ephemeral patch should work -- potentially including plants in temporary ponds). She has the ability to somehow modulate how many offspring she produces and how much investment goes into each offspring (note again for emphasis -- 'parental investment' is not synonymous with 'parental care', and investment might take the form of, e.g., increased egg provisioning or egg guarding). If she observes the density of competitors to be low, then she should make relatively low PI and produce more offspring. If she observes the density of competiters to instead by high, her PI should be elevated and conseqent offspring reduction reduced. It might be possible to test for this by comparing a focal female's offspring production across a density gradient of competitors who are fertile versus sterile. Consider, e.g., the simple case:

1. A focal female ovipositing on a patch at low density of competitors.
2. A focal female ovipositing on a patch at high density of competitors.
3. A focal female ovipositing on a patch at high density of **sterile** competitors.
4. A focal female ovipositing on a patch at high density of competitors *that cannot physically interfere.*

If females cannot or do not modulate PI with competition, then we would predict no significant difference between a focal female's offspring production in 1 and 3. But if females can modulate PI with competition, then we would predict offspring produced in 3 to be *lower* than offspring produced in 1 due to the effect of intimidation from competitors, but perhaps for these offspring to have traits more associated with higher viability (e.g., larger body size, higher feeding rate). We should also predict offspring production to be much lower in 2 than either 1 or 3 due to effects of competition among larvae. The addition of 4 might be needed to control for effects of competitors physically interfering with the focal female (even if they are sterile). The idea might be to have a mesh separating the focal female physically but still give the illusion of high density in the surrounding area.

Four cases of evolution and competition (ignore -- wrong approach)
--------------------------------------------------------------------------------

**EVERYTHING BELOW IS BAD -- it's an original approach before trying the random matrix stuff**.

**I. Slow evolution. Competition increases with increased offspring production**

Allow us to start by considering the very simple case where $a = 0$ and $b = 1$, which effectively makes competition only a function of offspring production (because $m_{j}^{0} = 1$), as assumed in @Parker1986. This implies that $\partial NW / \partial m > 0$ for all combinations of $i$ and $j$; that is, there will be a *direct positive effect of evolution on ecology* because the growth rate of both species will increase with increasing $m_{i}$ and $m_{j}$ due to decreased competition. Note, we cannot model decrease in $n_i$ and $n_j$ (rather, we don't need to) because of complete degeneracy for perfectly correlated traits [@Patel2018] -- i.e., it's effectively the same trait.

Additionally, there will be a *direct positive effect of ecology on PI evolution* because higher densities cause increased parental investment and therefore higher values of $m_{i}$ and $m_{j}$. Finally, we need to assume that the trace of $\boldsymbol{D}$ is negative to make the system evolutionarily stable. I'll need to think about how this is a reasonable or unreasonable assumption.

$$\boldsymbol{J} = \begin{bmatrix}
    -  & - & + & + \\
    -  & - & + & + \\
    \varepsilon(+)  & \varepsilon(+) & - & 0 \\
    \varepsilon(+)  & \varepsilon(+) & 0 & - \\
\end{bmatrix}.$$

I believe that the above is correct for this simplified case. Small positive values ($\varepsilon$ is small) in the lower left subset of the matrix imply that an increase in density (of either species) increases parental investment (of either species) and decreases offspring number, as demonstrated above. 

To start, I am going to **set intraspecific competition as slightly higher than interspecific competition** and see how the feedback of density on traits affects coexistence through assessing the stability criteria of @Patel2018. Under these conditions, ecological dynamics should be stable, leading to extinction of species because. This can be modelled with the submatrix $\boldsymbol{A}$,

$$\boldsymbol{A} = \begin{bmatrix}
    -1      & -0.9  \\
    -0.9    & -1    \\
\end{bmatrix}.$$
                   
```{r, echo = TRUE}
A <- matrix(data = c(-1, -0.9, -0.9, -1), nrow = 2, ncol = 2);
```
                   
Stable coexistence of species occurs when the real component of the leading eigenvalue of the Jacobian matrix is negative. In the case of $\boldsymbol{A}$ above, the leading eigenvalue is negative, which implies an stable system.
                   
 ```{r, echo = TRUE}
s_A <- eigen(A)$values; print(s_A);
```                 
           
Now the point is to look at the stability criteria of the feedback between species density and trait change and see if it drives the system to be unstable. The stability criteria given slowly-evolving traits requires that the ecology be stable, and for  [@Patel2018],

$$s\left(\boldsymbol{D} + \boldsymbol{C}\boldsymbol{A}^{-1}(-\boldsymbol{B})\right) < 0.$$

Where $\boldsymbol{A}$, $\boldsymbol{B}$, $\boldsymbol{C}$, and $\boldsymbol{D}$, are defined within $\boldsymbol{J}$ above. Verbally, we need to do element-wise addition of $\boldsymbol{D}$ to the matrix product of $\boldsymbol{C}$ and inverse of $\boldsymbol{A}$, then multiply by $\boldsymbol{B}$ where all elements are multiplied by $-1$. If the resulting matrix has a real component of the leading eigenvalue that is less than zero, then the feedbacks between ecology and evolution will be stabilising. Assume $\varepsilon = 0.001$, so,

$$\boldsymbol{B} = \begin{bmatrix}
    1       & 1   \\
    1       & 1  \\
\end{bmatrix},$$

$$\boldsymbol{C} = \begin{bmatrix}
    1      & 1  \\
    1      & 1  \\
\end{bmatrix},$$ and

$$\boldsymbol{D} = \begin{bmatrix}
    -1   & 0  \\
    0   & -1  \\
\end{bmatrix}.$$

Note that values of $\varepsilon$ are not themselves incorporated into the matrices -- the effect of high versus low $\varepsilon$ is incorporated into stability criteria.

```{r, echo = TRUE}
B      <- matrix(data = 1, nrow = 2, ncol = 2);
C      <- matrix(data = 1, nrow = 2, ncol = 2);
D      <- matrix(data = c(-1, 0, 0, -1), nrow = 2, ncol = 2);
AA    <- D + C %*% solve(A) %*% (-B);
s_AA  <- eigen(AA)$values; print(s_AA);
```


**Conclusion for I:** The **feedback between ecology and evolution therefore destabilises the whole system**, meaning that population densities and traits will not return to their original state if perturbed.


**II. Slow evolution. Competition increases with increased parental investment**

**Now let's try things when the exponent $a = 1$ but $b = 0$, which effectively makes competition *only* a result of parental investment per offspring** (admittedly, it's hard to imagine why this would ever be, but let's give it a try first). This results in the following Jacobian matrix,

$$\boldsymbol{J} = \begin{bmatrix}
    -  & - & - & - \\
    -  & - & - & - \\
    \varepsilon(+)  & \varepsilon(+) & - & 0 \\
    \varepsilon(+)  & \varepsilon(+) & 0 & - \\
\end{bmatrix}.$$

Note that the only thing has changed is $\boldsymbol{B}$; now an increase in $m$ *decreases* population growth because $m_{i}$ and $m_{j}$ both increase copetition. The values in $\boldsymbol{C}$ do not change because evolution should, else being equal, still cause increased parental investment with increased population size,

$$\boldsymbol{B} = \begin{bmatrix}
    -1       & -1  \\
    -1       & -1  \\
\end{bmatrix}$$

We have the same stability criteria $s\left(\boldsymbol{D} + \boldsymbol{C}\boldsymbol{A}^{-1}(-\boldsymbol{B})\right) < 0$ as above for the case where competition increased with offspring number $n$. We only need to change $\boldsymbol{B}$ to assess it.

```{r, echo = TRUE}
B      <- matrix(data = -1, nrow = 2, ncol = 2);
AA    <- D + C %*% solve(A) %*% (-B);
s_AA  <- eigen(AA)$values; print(s_AA);
```

**Conclusion II.** In the above, the leading eigenvalue is negative, so **the whole system is stable. Hence, when competition increases with increasing parental investment as opposed to increasing offspring number, the whole system is also stable.** Note that under these conditions (slow evolution), the whole system cannot be stable if $\boldsymbol{A}$ by itself (the ecology) is not stable.

**III. Fast evolution. Competition increases with increased offspring production**
     
Here we need to go back to our positive values in $\boldsymbol{B}$ for $m$ and negative values for $n$,

$$\boldsymbol{B} = \begin{bmatrix}
    1       & 1   \\
    1       & 1   \\
\end{bmatrix}.$$

```{r, echo = TRUE}
B      <- matrix(data = 1, nrow = 2, ncol = 2);
```

But a new stability criteria is needed for when evolution happens quickly relative to ecology (high $\varepsilon$), as shown by @Patel2018. We might also consider this kind of situation as occurring when individuals can plastically respond to their environment to adjust parental investment as the situation requires to maximise their inclusive fitness. **Note that, as mentioned above, the evolution of the system is neutrally stable**; there are only complete negative correlations between a single species $m$ and $n$, and the eigenvalues of $\boldsymbol{D}$ are all unity. Consequently, **the stability caused by feedbacks between ecology and evolution solely determine the stability of the system as a whole**. The stability criteria under these circumstances are as follows,

$$s\left(\boldsymbol{A} + \boldsymbol{B}\boldsymbol{D}^{-1}(-\boldsymbol{C})\right) < 0$$

```{r, echo =TRUE}
AA    <- A + B %*% solve(D) %*% (-C);
s_AA  <- eigen(AA)$values; print(s_AA);
```

**Conclusion III.** The leading eigenvalue of the above is positive, meaning that **when individuals can quickly adjust their parental investment and offspring production (or traits quickly evolve), and competition is determined by offspring number**, the whole system is unstable, even if the ecology by itself *is* stable.

**IV. Fast evolution. Competition increases with increased parental investment**

To determine the stability when evolution is fast, but competition increases with increased parental investment, we must start by first putting $\boldsymbol{B}$ back to what it was.

$$\boldsymbol{B} = \begin{bmatrix}
    -1       & -1   \\
    -1       & -1   \\
\end{bmatrix}.$$

```{r, echo = TRUE}
B      <- matrix(data = -1, nrow = 2, ncol = 2);
```

We then test the stability criteria.

```{r, echo = TRUE}
B      <- matrix(data = -1, nrow = 2, ncol = 2);
AA     <- A + B %*% solve(D) %*% (-C);
s_AA   <- eigen(AA)$values; print(s_AA);
```

**Conclusion IV.** Less interesting than it sounds; **when competition is increased by parental investment, the rapid change in traits stabilises the whole system.** (recall that we have defined the system to be evolutionarily stable a priori). Unfortunately, it **very** rarely stabilises a system that is not already stable. The code below finds one case:

```{r, echo = TRUE}
vals <- NULL;
for(i in 1:10000){
    u      <- runif(n = 4, min = -10, max = -0.0001);
    v      <- runif(n = 8, min = 0, max = 10);
    A      <- matrix(data = c(u[1], u[2], u[3], u[4]), nrow = 2, ncol = 2);
    if(max(Re(eigen(A)$values)) > 0){
        B      <- matrix(data = c(v[1], v[2], v[3], v[4]), nrow = 2, ncol = 2);
        C      <- matrix(data = c(v[5], v[6], v[7], v[8]), nrow = 2, ncol = 2);
        AA     <- A + B %*% solve(D) %*% (-C);
        s_AA   <- eigen(AA)$values; 
        vals   <- c(vals, max(Re(s_AA)));
        if(max(Re(s_AA)) < 0){
            break;
        }
    }
}
print(A);
print(B);
print(C);
print(D);
print(eigen(A)$values);
print(eigen(AA)$values);
print(paste("Stabilising evolution finally found after ", i, "tries"));
```

Essentially, how quickly everything happens needs to differe between species.
                  
References
--------------------------------------------------------------------------------
                   
                   
                   
                   
                   
                   
                   
                   
                   
                   
                   